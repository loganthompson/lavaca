<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/ui/Form.js - lavaca</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="lavaca"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.3.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/lavaca.env.Device.html">lavaca.env.Device</a></li>
            
                <li><a href="../classes/lavaca.events.EventDispatcher.html">lavaca.events.EventDispatcher</a></li>
            
                <li><a href="../classes/lavaca.fx.Animation.html">lavaca.fx.Animation</a></li>
            
                <li><a href="../classes/lavaca.fx.Spring.html">lavaca.fx.Spring</a></li>
            
                <li><a href="../classes/lavaca.fx.Transform.html">lavaca.fx.Transform</a></li>
            
                <li><a href="../classes/lavaca.fx.Transition.html">lavaca.fx.Transition</a></li>
            
                <li><a href="../classes/lavaca.mvc.Application.html">lavaca.mvc.Application</a></li>
            
                <li><a href="../classes/lavaca.mvc.AttributeEvent.html">lavaca.mvc.AttributeEvent</a></li>
            
                <li><a href="../classes/lavaca.mvc.Collection.html">lavaca.mvc.Collection</a></li>
            
                <li><a href="../classes/lavaca.mvc.Controller.html">lavaca.mvc.Controller</a></li>
            
                <li><a href="../classes/lavaca.mvc.ItemEvent.html">lavaca.mvc.ItemEvent</a></li>
            
                <li><a href="../classes/lavaca.mvc.Model.html">lavaca.mvc.Model</a></li>
            
                <li><a href="../classes/lavaca.mvc.Route.html">lavaca.mvc.Route</a></li>
            
                <li><a href="../classes/lavaca.mvc.Router.html">lavaca.mvc.Router</a></li>
            
                <li><a href="../classes/lavaca.mvc.View.html">lavaca.mvc.View</a></li>
            
                <li><a href="../classes/lavaca.mvc.ViewManager.html">lavaca.mvc.ViewManager</a></li>
            
                <li><a href="../classes/lavaca.net.Connectivity.html">lavaca.net.Connectivity</a></li>
            
                <li><a href="../classes/lavaca.net.History.html">lavaca.net.History</a></li>
            
                <li><a href="../classes/lavaca.storage.LocalStore.html">lavaca.storage.LocalStore</a></li>
            
                <li><a href="../classes/lavaca.storage.Store.html">lavaca.storage.Store</a></li>
            
                <li><a href="../classes/lavaca.ui.DustTemplate.html">lavaca.ui.DustTemplate</a></li>
            
                <li><a href="../classes/lavaca.ui.Form.html">lavaca.ui.Form</a></li>
            
                <li><a href="../classes/lavaca.ui.LoadingIndicator.html">lavaca.ui.LoadingIndicator</a></li>
            
                <li><a href="../classes/lavaca.ui.Template.html">lavaca.ui.Template</a></li>
            
                <li><a href="../classes/lavaca.ui.Widget.html">lavaca.ui.Widget</a></li>
            
                <li><a href="../classes/lavaca.util.ArrayUtils.html">lavaca.util.ArrayUtils</a></li>
            
                <li><a href="../classes/lavaca.util.Cache.html">lavaca.util.Cache</a></li>
            
                <li><a href="../classes/lavaca.util.Config.html">lavaca.util.Config</a></li>
            
                <li><a href="../classes/lavaca.util.DateUtils.html">lavaca.util.DateUtils</a></li>
            
                <li><a href="../classes/lavaca.util.Disposable.html">lavaca.util.Disposable</a></li>
            
                <li><a href="../classes/lavaca.util.extend.html">lavaca.util.extend</a></li>
            
                <li><a href="../classes/lavaca.util.Map.html">lavaca.util.Map</a></li>
            
                <li><a href="../classes/lavaca.util.Promise.html">lavaca.util.Promise</a></li>
            
                <li><a href="../classes/lavaca.util.resolve.html">lavaca.util.resolve</a></li>
            
                <li><a href="../classes/lavaca.util.StringUtils.html">lavaca.util.StringUtils</a></li>
            
                <li><a href="../classes/lavaca.util.Translation.html">lavaca.util.Translation</a></li>
            
                <li><a href="../classes/lavaca.util.uuid.html">lavaca.util.uuid</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/ui/Form.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
define(function(require) {

  var $ = require(&#x27;$&#x27;),
      Widget = require(&#x27;lavaca/ui/Widget&#x27;),
      Promise = require(&#x27;lavaca/util/Promise&#x27;);

  function _required(value) {
    return value ? null : &#x27;error_required&#x27;;
  }

  function _pattern(value, input) {
    if (value) {
      var pattern = new RegExp(input.attr(&#x27;pattern&#x27;));
      if (!pattern.test(value)) {
        return &#x27;error_pattern&#x27;;
      }
    }
    return null;
  }

  function _email(value) {
    if (value &amp;&amp; !/[a-z0-9!#$%&amp;&#x27;*+/=?^_&#x60;{|}~-]+(?:\.[a-z0-9!#$%&amp;&#x27;*+/=?^_&#x60;{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/.test(value.toLowerCase())) { //&#x27; fix SublimeText syntax highlighting
      return &#x27;error_email&#x27;;
    }
    return null;
  }

  function _tel(value) {
    if (value &amp;&amp; !/^\d?(\d{3})?\d{7}$/.test(value.replace(/\D/g, &#x27;&#x27;))) {
      return &#x27;error_tel&#x27;;
    }
    return null;
  }

  function _number(value) {
    if (value &amp;&amp; !/^\d+(\.\d+)?$/.test(value)) {
      return &#x27;error_number&#x27;;
    }
    return null;
  }

  function _url(value) {
    if (value &amp;&amp; !/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2})/.test(value)) {
      return &#x27;error_url&#x27;;
    }
    return null;
  }

  /**
   * Basic form type
   * @class lavaca.ui.Form
   * @extends lavaca.ui.Widget
   *
   * @constructor
   * @param {jQuery} el  The DOM element that is the root of the widget
   */
  var Form = Widget.extend(function() {
    Widget.apply(this, arguments);
    var self = this;
    this.pendingSync = {};
    this._onChangeInput = function(e) {
      self.onChangeInput(e);
    };
    this._onSubmit = function(e) {
      self.onSubmit(e);
    };
    this.el.on(&#x27;submit&#x27;, this._onSubmit);
    this.el.on(&#x27;input&#x27;, function(e) {
      this.autoAdvanceIfNecessary($(e.target));
    }.bind(this));
    this.formatters = [];
    this.rules = [];
    this.addRule(this.defaultRules());
  }, {
    /**
     * Whether input values should automatically be trimmed
     * @property autoTrim
     * @default false
     * @type Boolean
     */
    autoTrim: false,
    /**
     * Whether the focus should automatically advance to the
     * next input when the input&#x27;s value is equal to it&#x27;s maxlength
     * @property autoAdvance
     * @default false
     * @type Boolean
     */
    autoAdvance: false,
    /**
     * The default validation rules for the form
     * @method defaultRules
     *
     * @return {Object}  The form&#x27;s default rules1
     */
    defaultRules: function() {
      return {
        &#x27;[required]&#x27;: _required,
        &#x27;[pattern]&#x27;: _pattern,
        &#x27;[type=email]&#x27;: _email,
        &#x27;[type=tel]&#x27;: _tel,
        &#x27;[type=number]&#x27;: _number,
        &#x27;[type=url]&#x27;: _url
      };
    },
    /**
     * Calls submit on the Form&#x27;s element
     * @method submit
     */
    submit: function() {
      this.el.submit();
    },
    /**
     * Event handler for when the form is submitted
     * @method onSubmit
     *
     * @param {Event} e  The submit event
     */
    onSubmit: function(e) {
      e.preventDefault();
      this.validate()
        .success(this.onSubmitSuccess)
        .error(this.onSubmitError);
    },
    /**
     * Event handler for when the user attempts to submit a valid form
     * @method onSubmitSuccess
     *
     * @param {Object} values  Key-value map of the form&#x27;s input names and values
     */
    onSubmitSuccess: function() {
      // Placeholder
    },
    /**
     * Event handler for when the user attempts to submit an invalid form
     * @method onSubmitError
     *
     * @param {Object} invalidInputs  A key-value map of all invalid inputs
     */
    onSubmitError: function() {
      // Placeholder
    },
    /**
     * Event handler for when an input on the form changes
     * @method onChangeInput
     *
     * @param {Event} e  The change event
     */
    onChangeInput: function(e) {
      if (this.model) {
        var input = $(e.target),
            name = input.attr(&#x27;name&#x27;),
            value = _trim.call(this, input.val());
        this.pendingSync[name] = true;
        this.model.set(name, value);
        this.pendingSync[name] = false;
      }
    },
    /**
     * Event handler for when an attribute on the bound model changes
     * @method onChangeModel
     *
     * @param {Event} e  The change event
     */
    onChangeModel: function(e) {
      if (!this.pendingSync[e.attribute]) {
        this.set(e.attribute, e.value);
      }
    },
    /**
     * Binds this form to a model, forcing the two to stay in sync
     * @method bind
     *
     * @param {Lavaca.mvc.Model} model  The model being bound
     */
    bind: function(model) {
      this.unbind();
      this.model = model;
      model.on(&#x27;change&#x27;, this.onChangeModel, this);
      this.el.on(&#x27;change&#x27;, this._onChangeInput);
    },
    /**
     * Unbinds this form from its model
     * @method unbind
     */
    unbind: function() {
      if (this.model) {
        this.el.off(&#x27;change&#x27;, this._onChangeInput);
        this.model.off(&#x27;change&#x27;, this.onchangeModel, this);
        this.model = null;
      }
    },
    /**
     * Retrieve an input from the form with a given name
     * @method input
     *
     * @param {String} name  The name of the input
     * @return {jQuery}  The input
     */
    input: function(name) {
      return this.el.find(&#x27;input, select, textarea&#x27;).filter(&#x27;[name=&quot;&#x27; + name + &#x27;&quot;]&#x27;);
    },
    /**
     * Gets the value of an input on the form
     * @method get
     *
     * @param {String} name  The name of the input
     * @return {String}  The value of the input
     */
    /**
     * Gets the value of an input on the form
     * @method get
     *
     * @param {jQuery} input  The input, textarea, or select
     * @return {String}  The value of the input
     */
    get: function(inputs) {
      var result = null,
          i = -1,
          input,
          value,
          type;
      if (typeof inputs === &#x27;string&#x27;) {
        inputs = this.input(inputs);
      }
      while (!!(input = inputs[++i])) {
        input = $(input);
        type = (input.attr(&#x27;type&#x27;) || &#x27;&#x27;).toLowerCase();
        if ((type === &#x27;radio&#x27; || type === &#x27;checkbox&#x27;) &amp;&amp; !input[0].checked) {
          continue;
        }
        value = _trim.call(this, input.val());
        if (result instanceof Array) {
          result.push(value);
        } else if (result !== null) {
          result = [result, value];
        } else {
          result = value;
        }
      }
      return result;
    },
    /**
     * Sets the value of an input on the form
     * @method set
     *
     * @param {String} name  The name of the input
     * @param {String} value  The new value of the input
     */
    /**
     * Sets the values of multiple inputs on the form
     * @method set
     *
     * @param {Object} values  A hash of input names and values
     */
    set: function(name, value) {
      var input, type;
      if (typeof name === &#x27;object&#x27;) {
        for (var key in name) {
          this.set(key, name[key]);
        }
      } else {
        input = this.input(name);
        type = (input.attr(&#x27;type&#x27;) || &#x27;&#x27;).toLowerCase();
        if (type === &#x27;radio&#x27;) {
          input.each(function() {
            this.checked = this.value === value;
          });
        } else if (type === &#x27;checkbox&#x27;) {
          input.prop(&#x27;checked&#x27;, !!value);
        } else {
          input.val(value || null);
        }
        input.trigger(&#x27;change&#x27;, {manual: true});
      }
    },
    /**
     * Adds a validation rule to the form
     * @method addRule
     * @param {String} selector  A jQuery selector associated with the rule
     * @param {Function} callback  A function that tests the value of inputs matching the
     *   selector in the form callback(value, input, form) and
     *   return a string message if validation fails
     * @param {Boolean} [treatAsGroup]  (Optional) If true, the callback will be fired once
     *   with an array of values and inputs, one for each matching element. If false or ommitted,
     *   the callback will be fired once for each element that matches the selector.
     */
    /**
     * Adds multiple validation rules to this form. The keys of the object
     * should be the selectors and the object&#x27;s values can either be a callback
     * or an object with the properties &#x27;callback&#x27; and &#x27;treatAsGroup&#x27;.
     * @method addRule
     *
     * @param {Object} map  A hash of selectors and callbacks to add as rules
     */
    addRule: function(selector, callback, treatAsGroup) {
      if (typeof selector === &#x27;object&#x27;) {
        for (var n in selector) {
          if (typeof selector[n] === &#x27;object&#x27;) {
            this.addRule(n, selector[n].callback, selector[n].treatAsGroup);
          } else {
            this.addRule(n, selector[n]);
          }
        }
      } else {
        this.rules.push({selector: selector, callback: callback, treatAsGroup: treatAsGroup});
      }
    },
    /**
     * Adds a formatter to the form
     * @method addFormatter
     * @param {String} selector  A jQuery selector associated with the formatter
     * @param {Function} callback  A function that takes three arguments (value, input, form) and
     *   returns a string which will be set as the value of the input.
     * @param {Boolean} [treatAsGroup]  (Optional) If true, the callback will be fired once
     *   with an array of values and inputs, one for each matching element. If false or ommitted,
     *   the callback will be fired once for each element that matches the selector.
     */
    /**
     * Adds multiple formatters to this form. The keys of the object
     * should be the selectors and the object&#x27;s values can either be a callback
     * or an object with the properties &#x27;callback&#x27; and &#x27;treatAsGroup&#x27;.
     * @method addFormatter
     *
     * @param {Object} map  A hash of selectors and callbacks to add as formatters
     */
    addFormatter: function(selector, callback, treatAsGroup) {
      if (typeof selector === &#x27;object&#x27;) {
        for (var n in selector) {
          if (typeof selector[n] === &#x27;object&#x27;) {
            this.addFormatter(n, selector[n].callback, selector[n].treatAsGroup);
          } else {
            this.addFormatter(n, selector[n]);
          }
        }
      } else {
        this.formatters.push({selector: selector, callback: callback, treatAsGroup: treatAsGroup});
      }
    },
    /**
     * Collects all input values on the form
     * @method values
     *
     * @return {Object}  A hash of input names and their values
     */
    values: function() {
      var result = {};
      this.el.find(&#x27;input, select, textarea&#x27;).each(function(index, el) {
        var $el = $(el),
            name = $el.attr(&#x27;name&#x27;),
            value;
        if (name) {
          value = this.get($el);
          if (value) {
            result[name] = value;
          }
        }
      }.bind(this));
      return result;
    },
    /**
     * Checks the entire form to see if it&#x27;s in a valid state
     * @method validate
     * @return {Lavaca.util.Promise}  A promise
     */
    /**
     * Checks the entire form to see if it&#x27;s in a valid state
     * @method validate
     * @param {Function} succcess  A callback to execute when the form is valid
     * @param {Function} error  A callback to execute when the form is invalid
     * @return {Lavaca.util.Promise}  A promise
     */
    /**
     * Checks the entire form to see if it&#x27;s in a valid state
     * @method validate
     * @param {jQuery} input  An input to check
     * @return {Lavaca.util.Promise}  A promise
     */
    /**
     * Checks the entire form to see if it&#x27;s in a valid state
     * @method validate
     * @param {Function} succcess  A callback to execute when the input is valid
     * @param {Function} error  A callback to execute when the input is invalid
     * @param {jQuery} input  An input to check
     * @return {Lavaca.util.Promise}  A promise
     */
    validate: function(success, error, input) {
      if (success &amp;&amp; typeof success !== &#x27;function&#x27;) {
        input = success;
        success = null;
      }
      if (input) {
        input = $(input);
      }
      var result = null,
          promise = new Promise(this);

      function validate(rule, value, ip, form) {
        var message = rule.callback.call(form, value, ip, form),
            name,
            id,
            label;
        if (message) {
          ip.each(function(index, el) {
            var $el = $(el);
            name = $el.attr(&#x27;name&#x27;);
            if (!result) {
              result = {};
            }
            if (!result[name]) {
              id = $el.attr(&#x27;id&#x27;);
              label = null;
              if (id) {
                label = form.el.find(&#x27;label[for=&quot;&#x27; + id + &#x27;&quot;]&#x27;).text();
              }
              result[name] = {
                id: id,
                name: name,
                label: label,
                el: $el,
                value: value,
                messages: []
              };
            }
            result[name].messages.push(message);
          });
        }
      }
      _matchAllInputs.call(this, this.rules, validate, input);
      if (result) {
        promise.reject(result);
      } else {
        promise.resolve(this.values());
      }
      return promise
        .error(function(inputs) {
          this.trigger(&#x27;invalid&#x27;, {inputs: inputs});
        })
        .success(function(values) {
          this.trigger(&#x27;valid&#x27;, values);
        })
        .success(success)
        .error(error);
    },
    /**
     * Formats all inputs
     * @method format
     */
    /**
     * Formats the specified inputs
     * @method format
     *
     * @param {jQuery} input  The inputs to format
     */
    format: function(input) {
      function cb(handler, value, ip, form) {
        var formattedValue = handler.callback.call(form, value, ip, form),
            event = jQuery.Event(&#x27;format&#x27;),
            unformattedValue = ip.val();
        ip.val(formattedValue);
        event.unformattedValue = unformattedValue;
        event.formattedValue = formattedValue;
        ip.trigger(event);
      }
      _matchAllInputs.call(this, this.formatters, cb, input);
    },
    /**
     * Automatically advances the focus to the
     * next input if autoAdvance is true and the
     * currently focussed input&#x27;s value is greater
     * than or equal to its maxlength
     * @method autoAdvanceIfNecessary
     *
     * @param {jQuery} [input]  (Optional) The current input. This
     *   parameter is just for speed optimization if the current input
     *   is already known. If not passed, it will be determined automatically.
     */
    autoAdvanceIfNecessary: function(input) {
      var $current, maxlength, value, $allInputs, $next;
      if (this.autoAdvance) {
        $current = input || this.el.find(&#x27;:focus&#x27;);
        maxlength = $current.attr(&#x27;maxlength&#x27;);
        value = $current.val();
        if (maxlength) {
          maxlength = parseInt(maxlength, 10);
          if (value.length &gt;= maxlength) {
            $allInputs = this.el.find(&#x27;input, text&#x27;);
            $next = $allInputs.eq($allInputs.index($current) + 1);
            if ($next.length) {
              $next.focus();
            } else {
              $current.blur();
            }
          }
        }
      }
    },
    /**
     * Ready the form for garbage collection
     * @method dispose
     */
    dispose: function() {
      this.unbind();
      Widget.prototype.dispose.call(this);
    }
  });
  /**
   * Extends the form with new submit handlers
   * @method withSubmit
   * @static
   *
   * @param {Function} success  The success handler
   * @param {Function} error  The error handler
   * @return {Function}  A new [@Lavaca.ui.Form]-derived type
   */
  Form.withSubmit = function(success, error) {
    return Form.extend({
      onSubmitSuccess: function(values) {
        success.call(this, values);
      },
      onSubmitError: function(inputs) {
        error.call(this, inputs);
      }
    });
  };

  function _trim(value) {
    if (this.autoTrim) {
      return value ? value.trim() : value;
    }
    return value;
  }

  // Common code used by formatters and rules
  function _matchAllInputs(handlers, callback, filterToInputs) {
    var i = -1,
        inputs,
        handler,
        value,
        j;
    while (!!(handler = handlers[++i])) {
      if (filterToInputs) {
        inputs = filterToInputs.filter(handler.selector);
        if (inputs.length &amp;&amp; handler.treatAsGroup) {
          inputs = inputs.add(this.el.find(handler.selector));
        }
      } else {
        inputs = this.el.find(handler.selector);
      }
      if (handler.treatAsGroup) {
        value = [];
        inputs.each(function(index, el) {
          value.push(this.get($(el)));
        }.bind(this));
        if (value.length) {
          callback.call(this, handler, value, inputs, this);
        }
      } else {
        j = -1;
        while (!!(ip = inputs[++j])) {
          ip = $(ip);
          value = this.get(ip);
          callback.call(this, handler, value, ip, this);
        }
      }
    }
  }

  return Form;

});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
